angular.module("drive.web.svg",["ui.bootstrap","colorpicker.module","drive.web.svg.services","drive.web.svg.controllers","drive.web.svg.directives"]).run(["$templateCache",function(t){t.put("partials/canvasDirective.html",'<div id="page-content-wrapper"><div class="page-content inset"><div class="row"><div class="col-md-12"><div class="btn-toolbar" role="toolbar"><div class="btn-group"><button type="button" ng-click="shapeSelecter(\'line\')" class="btn btn-default"><span class="glyphicon glyphicon-align-justify"></span> 直线</button><button type="button" ng-click="shapeSelecter(\'path\')" class="btn btn-default"><span class="glyphicon glyphicon-paperclip"></span> 曲线</button><button type="button" ng-click="shapeSelecter(\'ellipse\')" class="btn btn-default"><span class="glyphicon glyphicon-adjust"></span> 椭圆</button><button type="button" ng-click="shapeSelecter(\'rect\')" class="btn btn-default"><span class="glyphicon glyphicon-th-large"></span> 矩形</button></div><div class="btn-group"><button type="button" class="btn btn-default" ng-click="shapeSelecter(\'path\')"><span class="glyphicon glyphicon-pencil"></span> 画笔</button><button type="button" class="btn btn-default" ng-click="shapeSelecter(\'eraser\')"><span class="glyphicon glyphicon-book"></span> 橡皮</button><button type="button" class="btn btn-default" ng-click="shapeSelecter(\'text\')"><span class="glyphicon glyphicon-font"></span> 文字</button><button type="button" class="btn btn-default" ng-click="shapeSelecter(\'drag\')"><span class="glyphicon glyphicon-move"></span> 移动</button></div><div class="btn-group"><button type="button" class="btn btn-default" ng-disabled="undoButtonStatus" ng-click="doAction(\'undo\')"><span class="glyphicon glyphicon-circle-arrow-left"></span> 撤销</button><button type="button" class="btn btn-default" ng-disabled="redoButtonStatus" ng-click="doAction(\'redo\')"><span class="glyphicon glyphicon-circle-arrow-right"></span> 重做</button><button type="button" class="btn btn-default" ng-click="clearSVG()"><span class="glyphicon glyphicon-trash"></span> 清空</button><button type="button" class="btn btn-default" colorpicker colorpicker-position="bottom" style="background-color: {{stroke}};" ng-model="stroke"><span class="glyphicon glyphicon-th"></span> 取色</button></div></div></div><div class="col-md-8"><p class="well"><svg id="mysvg"></svg></p></div><div class="col-md-4"><p class="well">画板编号：{{goodowConstant.boardId}}.</p></div><div class="col-md-4"><p class="well">画笔颜色：{{stroke}}</p></div></div></div></div>')}]);
"use strict";angular.module("drive.web.svg.controllers",["drive.web.svg.services"]).controller("SVGController",["$scope","$window","graphService","realtimeService","goodowConstant","$log",function(e,t,o,a,l){e.undoButtonStatus="true",e.redoButtonStatus="true";var i=a(),n=n||{};n.realtimeDoc=null,n.list=n.list||{},n.list.FIELD_NAME="data",n.list.field=null,n.list.START_VALUE=[],n.map=n.map||{},n.initializeModel=function(e){n.list.initializeModel(e)},n.clear=function(e){"data"==e?n.realtimeDoc.getModel().getRoot().get("data").clear():"graph"==e&&o.clearGraph()},n.onFileLoaded=function(t){window.doc=t,n.realtimeDoc=t,n.list.loadField(),n.list.connectRealtime(t),n.list.connectUi(),t.getModel().onUndoRedoStateChanged(function(t){e.undoButtonStatus=!t.canUndo(),e.redoButtonStatus=!t.canRedo()})},n.handleErrors=function(e){e.type==realtime.store.ErrorType.TOKEN_REFRESH_REQUIRED?alert("TOKEN_REFRESH_REQUIRED"):e.type==realtime.store.ErrorType.CLIENT_ERROR?(alert("An Error happened: "+e.message),window.location.href="/"):e.type==realtime.store.ErrorType.NOT_FOUND&&(alert("The file was not found. It does not exist or you do not have read access to the file."),window.location.href="/")},n.list.loadField=function(){n.list.field=n.realtimeDoc.getModel().getRoot().get(n.list.FIELD_NAME)},n.list.initializeModel=function(e){var t=e.createList();t.pushAll(n.list.START_VALUE),e.getRoot().set(n.list.FIELD_NAME,t)},n.list.onRealtimeAdded=function(){n.list.connectUi()},n.list.onRealtimeRemoved=function(){n.clear("graph"),n.list.connectUi()},n.list.onRealtimeSet=function(){alert("onRealtimeSet")},n.list.connectRealtime=function(){n.list.field.onValuesAdded(n.list.onRealtimeAdded),n.list.field.onValuesRemoved(n.list.onRealtimeRemoved),n.list.field.onValuesSet(n.list.onRealtimeSet)},n.list.connectUi=function(){for(var t=n.list.field.asArray(),o=0,a=t.length;a>o;o++){var l=t[o].toJson();switch(l.type){case"line":for(var i=l.d,r=0;r<i.length;r++)i[r]=[500*i[r][0],800*i[r][1]];l.d=i,e.$apply(function(e){e.data={path:l}});break;case"path":for(var i=l.d,r=0;r<i.length;r++)i[r]=[500*i[r][0],800*i[r][1]];l.d=i,e.$apply(function(e){e.data={path:l}});break;case"rect":l.fill="none",l.x=500*l.x,l.y=800*l.y,l.width=500*l.width,l.height=800*l.height,e.$apply(function(e){e.data={rect:l}});break;case"ellipse":l.fill="none",l.cx=500*l.cx,l.cy=800*l.cy,l.rx=500*l.rx,l.ry=800*l.ry,e.$apply(function(e){e.data={ellipse:l}});break;case"text":e.$apply(function(e){e.data={text:l}})}}},n.list.converteToMap=function(e){var t={fill:0,stroke_width:3,rotate:0};for(var o in e)switch(t.stroke=e[o].stroke,o){case"path":for(var a=e[o].d,l=n.realtimeDoc.getModel().createList(),i=0;i<a.length;i++)l.push([(a[i][0]+.1)/500,(a[i][1]+.1)/800]);t.d=l,t.type=2==l.length?"line":"path";break;case"rect":var r=e[o];t.x=r.x/500,t.y=r.y/800,t.width=r.width/500,t.height=r.height/800,t.type="rect";break;case"ellipse":var d=e[o];t.cx=d.cx/500,t.cy=d.cy/800,t.rx=d.rx/500,t.ry=d.ry/800,t.type="ellipse";break;case"text":var s=e[o];t.x=s.x,t.y=s.y,t.text=s.text,t.fill=s.fill,t.type="text"}var c=n.realtimeDoc.getModel().createMap(t);for(var u in t)c.set(u,t[u]);return c},e.goodowConstant=l,i.load(e.goodowConstant.boardId,n.onFileLoaded,n.initializeModel,n.handleErrors),e.$watch("goodowConstant.boardId",function(e,t){e!=t&&(n.clear("graph"),i.load(e,n.onFileLoaded,n.initializeModel,n.handleErrors))}),e.$watch("sendData",function(){e.sendData&&n.list.field.push(n.list.converteToMap(e.sendData))}),e.clearSVG=function(){n.clear("data")},e.shapeSelecter=function(t){"eraser"==t?(e.shape="path",e.stroke_width="10",e.stroke="white"):(e.shape=t,e.stroke_width=null,e.stroke=null)},e.doAction=function(e){var t=n.realtimeDoc.getModel();"undo"==e?t.undo():t.redo()}}]).controller("ModalDemoCtrl",["$scope","$modal","$log","goodowConstant",function(e,t,o,a){e.board={boardId:null,width:500,height:800},e.open=function(i){var n=t.open({templateUrl:i+".html",controller:l,size:"",resolve:{board:function(){return e.board}}});n.result.then(function(e){a.setBoardId(e.boardId)},function(){o.info("Modal dismissed at: "+new Date)})};var l=function(e,t,o){e.boardModal=o,e.submit=function(){t.close(o)},e.cancel=function(){t.dismiss("cancel")}}}]);
angular.module("drive.web.svg.directives",["drive.web.svg.services"]).directive("goodowcanvas",["realtimeService","goodowConstant","graphService",function(t,e,r){function a(t,e){"rect"==e.type?t.attr("width",e.width).attr("height",e.height).attr("x",e.startX).attr("y",e.startY):"ellipse"==e.type?t.attr("rx",e.rx).attr("ry",e.ry).attr("cx",e.startX).attr("cy",e.startY):"path"==e.type&&t.attr("d",s(e.d))}var s=r.lineFunction(),i=function(t){var e=d3.select("#mysvg").append("g"),r=e.append(t.type).attr("fill",t.fill).attr("stroke",t.stroke).attr("stroke-width",t.stroke_width).attr("stroke-dasharray",t.stroke_dasharray).attr("stroke-linecap","round");return r},o=function(e,o){var d,h={fill:"none",stroke:"blue",stroke_width:1,stroke_dasharray:"1,2",canDraw:!1,hasDrawFinish:!0};d=angular.extend({},h),d.d=[],e.$watch("data",function(){var t,a=e.data;for(var s in a)t=angular.extend({},a[s]),t.type=s,r.drawGraph(t)});var n,l,c,p,f=o.find("svg")[0];d3.select(f).on("click",function(){if("text"==e.shape){var t=d3.select("#mysvg").append("g"),r=t.append("text"),a=(r.attr("x",d3.event.offsetX).attr("y",d3.event.offsetY).text("文字").attr("fill","red"),{});a.text={},a.text.x=d3.event.offsetX,a.text.y=d3.event.offsetY,a.text.text="文字",a.text.fill="red",e.$apply(function(t){t.sendData=a,console.log(JSON.stringify(a))})}else"drag"==e.shape}),d3.select(f).on("mousedown",function(){var t=this;if(1==d3.event.which)switch(e.shape){case"ellipse":d.type="ellipse",d.rx=0,d.ry=0,d.tempX=d3.event.offsetX,d.tempY=d3.event.offsetY,d.canDraw=!0,d.hasDrawFinish=!1,n=i(d);break;case"rect":d.type="rect",d.width=0,d.height=0,d.startX=d.tempX=d3.event.offsetX,d.startY=d.tempY=d3.event.offsetY,d.canDraw=!0,d.hasDrawFinish=!1,l=i(d);break;case"path":d.type="path",d.d=[],d.d.push([d3.event.offsetX,d3.event.offsetY]),d.canDraw=!0,d.hasDrawFinish=!1,c=i(d);break;case"line":d.type="path",d.d=[],d.d.push([d3.event.offsetX,d3.event.offsetY]),d.canDraw=!0,d.hasDrawFinish=!1,p=i(d)}d3.select(t).on("mouseup",function(){var t=this,r=void 0==e.fill?"none":e.fill,a=void 0==e.stroke?"black":e.stroke;if(1==d3.event.which){d3.select(t).attr("style","cursor:default"),d.canDraw=!1,d.hasDrawFinish=!0;var i={};switch(e.shape){case"ellipse":n.attr("fill",r).attr("stroke-width",e.stroke_width).attr("stroke",a).attr("stroke-dasharray",""),i.ellipse={},i.ellipse.cx=d.startX,i.ellipse.cy=d.startY,i.ellipse.rx=d.rx,i.ellipse.ry=d.ry,i.ellipse.fill=r,i.ellipse.stroke=a,i.ellipse["stroke-width"]=e.stroke_width;break;case"rect":l.attr("fill",r).attr("stroke-width",e.stroke_width).attr("stroke",a).attr("stroke-dasharray",""),i.rect={},i.rect.x=d.startX,i.rect.y=d.startY,i.rect.width=d.width,i.rect.height=d.height,i.rect.fill=r,i.rect.stroke=a,i.rect["stroke-width"]=e.stroke_width;break;case"path":var o=void 0==e.stroke_width||0==e.stroke_width?1:e.stroke_width,h=void 0==e.stroke?"black":e.stroke;c.attr("d",s(d.d)).attr("stroke-width",o).attr("stroke",h).attr("fill","none").attr("stroke-dasharray",""),i.path={},i.path.d=d.d,i.path.fill=e.fill,i.path.stroke=h,i.path["stroke-width"]=o;break;case"line":var o=void 0==e.stroke_width||0==e.stroke_width?1:e.stroke_width,h=void 0==e.stroke?"black":e.stroke;p.attr("d",s(d.d)).attr("stroke-width",o).attr("stroke",h).attr("fill","none").attr("stroke-dasharray",""),i.path={},i.path.d=d.d,i.path.fill=e.fill,i.path.stroke=h,i.path["stroke-width"]=o}}e.$apply(function(t){t.sendData=i}),d3.select(t).on("mousemove",null).on("mouseup",null)}).on("mousemove",function(){if(d.canDraw){var t=this;d3.select(t).attr("style","cursor:crosshair");var r=d3.event.offsetX,i=d3.event.offsetY;switch(e.shape){case"rect":d.width=r-d.tempX,d.height=i-d.tempY,d.width<0&&(d.startX=r,d.width=Math.abs(d.width)),d.height<0&&(d.startY=i,d.height=Math.abs(d.height)),a(l,d);break;case"ellipse":d.rx=Math.abs(r-d.tempX)/2,d.ry=Math.abs(i-d.tempY)/2,d.startX=d.tempX+(r-d.tempX)/2,d.startY=d.tempY+(i-d.tempY)/2,a(n,d);break;case"path":d.d.push([d3.event.offsetX,d3.event.offsetY]),c.attr("d",s(d.d));break;case"line":d.d=[d.d[0]],d.d.push([d3.event.offsetX,d3.event.offsetY]),p.attr("d",s(d.d))}}})}),o.on("$destroy",function(){t.close()})};return{restrict:"E",controller:"SVGController",link:o,templateUrl:"partials/canvasDirective.html"}}]);
var serviceModule;!function(t,r){serviceModule=r.module("drive.web.svg.services",[]).factory("goodowConstant",function(){return this.SERVER="http://krx2.retechcorp.com:1986/channel",this.boardId="svg/1",this.setBoardId=function(t){this.boardId="svg/"+t},this}).factory("realtimeService",["goodowConstant",function(r){return function(){return t.store=new realtime.store.StoreImpl(r.SERVER,null),store}}]).factory("goodowUtil",function(){function t(t,r){t.style("-webkit-transform",r).style("-moz-transform",r).style("-o-transform",r).style("transform",r)}return{transform:t}}).factory("graphService",["goodowUtil",function(t){var e=d3.svg.line().x(function(t){return t[0]}).y(function(t){return t[1]}).interpolate("linear"),n=null,o=null,a=function(r,e){if("rect"===r.type){var n=e.append("g").append("rect");n.attr("fill",r.fill).attr("stroke",r.stroke).attr("stroke-width",r["stroke-width"]).attr("stroke-linecap","round"),n.attr("x",r.x).attr("y",r.y).attr("width",r.width).attr("height",r.height),r.transform&&t.transform(n,"rotate("+r.transform.rotate+"deg)")}},i=function(r,e){function n(t){t.x+=d3.event.dx,t.y+=d3.event.dy,d3.select(this).attr("transform","translate("+t.x+","+t.y+")")}var o=e.append("g").append("ellipse");o.attr("fill",r.fill).attr("stroke",r.stroke).attr("stroke-width",r["stroke-width"]).attr("stroke-linecap","round"),o.attr("cx",r.cx).attr("cy",r.cy).attr("rx",r.rx).attr("ry",r.ry),r.transform&&t.transform(o,"rotate("+r.transform.rotate+"deg)");var a=d3.behavior.drag().on("drag",n);o.style("cursor","pointer").call(a).on("mouseover",function(){d3.select(this).style("fill","aliceblue")}).on("mouseout",function(){d3.select(this).style("fill","none")})},s=function(n,o){var a=o.append("g").append("path");a.attr("stroke",n.stroke).attr("stroke-width",n["stroke-width"]).attr("fill","none").attr("stroke-linecap","round"),r.isArray(n.d)&&n.d.length>=2&&a.attr("d",e(n.d)),n.transform&&t.transform(a,"rotate("+n.transform.rotate+"deg)")},l=function(r,e){{var n=e.append("g").append("text");n.attr("x",r.x).attr("y",r.y).text(r.text).attr("fill",r.fill)}r.transform&&t.transform(path,"rotate("+r.transform.rotate+"deg)")},d={ellipse:i,path:s,rect:a,text:l};return{drawGraph:function(t){var e=d[t.type],a=d3.select("#mysvg");if(n=a.property("height").animVal.value,o=a.property("width").animVal.value,!r.isFunction(e))throw new Error(e+" is not a function");e.call(null,t,a)},lineFunction:function(){return e},clearGraph:function(){d3.selectAll("svg > *").remove()}}}])}(window,angular);